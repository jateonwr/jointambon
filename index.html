<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaflet – TH Points • ใช้ GeoJSON จาก Repo</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{--bg:#0b1020;--card:#10182b;--muted:#a9b0c0;--accent:#1e90ff}
    html,body{height:100%;margin:0;font-family:'Sarabun',system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:#0b0f1a;color:#f3f6fb}
    .app{display:grid;grid-template-columns:460px 1fr;gap:14px;height:100%;padding:14px;box-sizing:border-box}
    .panel{background:var(--card);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.3);padding:14px;display:flex;flex-direction:column;min-height:0}
    h1{font-size:18px;margin:.2rem 0 10px;font-weight:700}
    h2{font-size:14px;margin:16px 0 8px;color:var(--muted);font-weight:700;letter-spacing:.2px}
    label{font-size:13px;color:#cfd6e6;margin-bottom:6px;display:block}
    .btn{background:linear-gradient(180deg,#1e90ff,#1475d6);border:none;color:white;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-outline{background:transparent;border:1px solid #2a3354;color:#d6e5ff}
    .btn-danger{background:transparent;border:1px solid #703a3a;color:#ffbcbc}
    .muted{color:var(--muted);font-size:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    #map{width:100%;height:100%;min-height:520px;border-radius:14px;overflow:hidden}
    .kvs{display:grid;grid-template-columns:140px 1fr;gap:6px;align-items:center}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#0f1a33;border:1px solid #233056;color:#b7c3de;padding:4px 8px;border-radius:999px;font-size:11px}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .dot{inline-size:10px;block-size:10px;border-radius:50%;background:#1e90ff;border:1px solid #fff3}
    .poly{inline-size:14px;block-size:10px;border:1px solid #64ffda;background:linear-gradient(0deg,#64ffda22,#64ffda22)}
    .divider{height:1px;background:#243056;margin:10px 0}
    .small{font-size:11px;color:#9fb0d0}
    .toast{position:fixed;right:16px;bottom:16px;background:#111a2e;border:1px solid #233056;padding:10px 14px;border-radius:10px;color:#dbe6ff;box-shadow:0 6px 24px rgba(0,0,0,.35);z-index:9999}
    .hint{font-size:12px;color:#b8c7ea;margin-top:6px}
    .tableWrap{min-height:220px;max-height:360px;overflow:auto;border:1px solid #243056;border-radius:10px;background:#0e1526}
    table{width:100%;border-collapse:collapse;font-size:12.5px}
    thead th{position:sticky;top:0;background:#101a34;color:#e8f0ff;border-bottom:1px solid #243056;padding:8px;font-weight:700;text-align:left}
    tbody td{border-bottom:1px solid #1d2846;padding:6px 8px;color:#dbe6ff;vertical-align:middle}
    tbody tr:hover{background:#0f1830}
    .t-num{width:44px}
    .t-actions{width:86px;text-align:right}
    .pill{display:inline-block;padding:2px 6px;border-radius:999px;border:1px solid #2b3a63;background:#0d1833;font-size:11px}
    .countRow{display:flex;justify-content:space-between;align-items:center;margin-top:6px;color:#9fb0d0;font-size:12px}
    .note{font-size:12px;color:#a9b0c0}
    input[type="number"].celled{width:110px;background:#0e1526;border:1px solid #1f2942;color:#eaf1ff;padding:6px 8px;border-radius:8px;outline:none}
    .row-editor{background:#0f1933}
    .row-editor td{position:sticky; top:32px; background:#0f1933; border-bottom:1px solid #233056;}
    @media (max-width: 980px){
      .app{grid-template-columns:1fr;grid-template-rows:auto 1fr}
      #map{min-height:480px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel" style="min-width:0">
      <h1>Thailand Map • ใช้ GeoJSON จาก Repo (อัตโนมัติ)</h1>
      <div class="legend">
        <span class="badge"><span class="dot"></span> จุด (Lat/Lon)</span>
        <span class="badge"><span class="poly"></span> ขอบเขต (จาก subdistricts.geojson ใน repo)</span>
      </div>

      <h2>โหมดเพิ่มจุดจากแผนที่</h2>
      <div class="hint">• กด “เริ่มโหมดเพิ่มจากแผนที่” → คลิกตำแหน่ง → “ยืนยันเพิ่มจุด”</div>
      <div class="actions" style="margin-top:6px">
        <button class="btn" id="toggleAddModeBtn">เริ่มโหมดเพิ่มจากแผนที่</button>
        <button class="btn btn-outline" id="clearPointsBtn">ล้างจุดทั้งหมด</button>
      </div>

      <div class="divider"></div>

      <h2>ตารางจุด (แก้ไขในตาราง + เพิ่มแถวใหม่)</h2>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th class="t-num">#</th>
              <th>Lat</th>
              <th>Lon</th>
              <th>ตำบล</th>
              <th>อำเภอ</th>
              <th>จังหวัด</th>
              <th class="t-actions">ลบ</th>
            </tr>
          </thead>
          <tbody id="pointsTableBody">
            <tr class="row-editor">
              <td class="t-num"><span class="pill">ใหม่</span></td>
              <td><input id="newLat" class="celled" type="number" step="any" placeholder="13.7563"></td>
              <td><input id="newLon" class="celled" type="number" step="any" placeholder="100.5018"></td>
              <td colspan="3" class="small">พิมพ์ Lat/Lon แล้วกด “เพิ่มแถว” หรือใช้โหมดเพิ่มจากแผนที่</td>
              <td class="t-actions"><button class="btn" id="addNewRowBtn">เพิ่มแถว</button></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="countRow">
        <span>จำนวนจุดทั้งหมด: <span id="pointCount">0</span></span>
        <span class="note">คลิกจุดบนแผนที่เพื่อลบได้</span>
      </div>

      <div class="divider"></div>

      <h2>ขอบเขตจาก Repo</h2>
      <div class="small">ไฟล์ที่คาดหวัง: <code>subdistricts.geojson</code> (วางข้างไฟล์ HTML นี้)</div>
      <div id="gjStatus" class="muted" style="margin-top:6px">กำลังโหลด GeoJSON จาก repo…</div>

      <div id="fieldMapSection" style="display:none">
        <h2>แมปชื่อฟิลด์จาก Polygon</h2>
        <div class="kvs"><span>ตำบล (Tambon)</span><select id="fieldTambon"></select></div>
        <div class="kvs"><span>อำเภอ (Amphoe)</span><select id="fieldAmphoe"></select></div>
        <div class="kvs"><span>จังหวัด (Changwat)</span><select id="fieldChangwat"></select></div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn" id="joinBtn" disabled>Join จุด ↔ ขอบเขต</button>
        <button class="btn btn-outline" id="exportCsvBtn" disabled>Export CSV</button>
        <button class="btn btn-outline" id="exportXlsxBtn" disabled>Export Excel (.xlsx)</button>
        <button class="btn btn-outline" id="exportGeojsonBtn" disabled>Export GeoJSON</button>
      </div>

      <div style="margin-top:auto">
        <div class="divider"></div>
        <div class="small">Static • GitHub Pages พร้อมใช้ • Leaflet/Turf/SheetJS • Sarabun</div>
      </div>
    </div>

    <div id="map" class="panel"></div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script>
  const $ = (id) => document.getElementById(id);
  function toast(msg, ms=2200){ const el=$('toast'); el.textContent=msg; el.style.display='block'; setTimeout(()=>{el.style.display='none'}, ms); }
  function formatLatLon(n){ return (typeof n==='number' && isFinite(n)) ? n.toFixed(6) : n; }
  function toNumberMaybe(v){ if (typeof v==='number') return v; if (typeof v==='string'){ const s=v.trim().replace(/,/g,'.'); const f=parseFloat(s); return isNaN(f)?null:f;} return null; }
  function download(filename, data, mime='application/octet-stream'){ const blob=new Blob([data],{type:mime}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }

  // Map
  const map = L.map('map', {preferCanvas:true});
  const thBounds = L.latLngBounds([5.5, 97.3], [20.5, 105.7]);
  map.fitBounds(thBounds);
  const osmStd = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
  const osmHot = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OSM, HOT'});
  const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19,attribution:'Tiles &copy; Esri'});
  L.control.layers({'OSM (default)':osmStd,'OSM Humanitarian':osmHot,'Esri Imagery':esriSat},{},{collapsed:false}).addTo(map);
  L.control.scale().addTo(map);
  setTimeout(()=>map.invalidateSize(true),300);

  const polygonLayer = L.geoJSON(null,{style:{color:'#64ffda',weight:1,fillColor:'#64ffda',fillOpacity:0.12}}).addTo(map);
  const cluster = L.markerClusterGroup({ disableClusteringAtZoom: 13 }); map.addLayer(cluster);

  let points=[]; let nextId=1; let geojsonPolygons=null; let polyBBoxes=[];
  let addMode=false; let tempAddMarker=null;

  function setAddMode(on){ addMode=!!on; $('toggleAddModeBtn').textContent=addMode?'จบโหมดเพิ่มจากแผนที่':'เริ่มโหมดเพิ่มจากแผนที่'; if(addMode){ map.getContainer().classList.add('cursor-add'); toast('โหมดเพิ่ม: คลิกแผนที่แล้ว “ยืนยันเพิ่มจุด”'); } else { map.getContainer().classList.remove('cursor-add'); } if(tempAddMarker){ map.removeLayer(tempAddMarker); tempAddMarker=null;} }
  $('toggleAddModeBtn').addEventListener('click',()=> setAddMode(!addMode));
  $('clearPointsBtn').addEventListener('click',()=>{ points=[]; cluster.clearLayers(); refreshMarkers(); toast('ล้างจุดทั้งหมดแล้ว'); });

  function renderTable(){ const tb=$('pointsTableBody'); const editor=tb.querySelector('.row-editor'); tb.innerHTML=''; tb.appendChild(editor);
    points.forEach((p,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML=`
      <td class="t-num"><span class="pill">${idx+1}</span></td>
      <td><input class="celled" type="number" step="any" data-edit-lat="${p.id}" value="${formatLatLon(p.lat)}"></td>
      <td><input class="celled" type="number" step="any" data-edit-lon="${p.id}" value="${formatLatLon(p.lon)}"></td>
      <td>${p.props?.tambon ?? ''}</td>
      <td>${p.props?.amphoe ?? ''}</td>
      <td>${p.props?.changwat ?? ''}</td>
      <td class="t-actions"><button class="btn btn-danger" data-del="${p.id}" title="ลบแถวนี้">ลบ</button></td>`; tb.appendChild(tr); });
    $('pointCount').textContent=points.length.toLocaleString();
    tb.querySelectorAll('button[data-del]').forEach(btn=>btn.addEventListener('click',()=> removePointById(Number(btn.getAttribute('data-del')))));
    tb.querySelectorAll('input[data-edit-lat]').forEach(inp=>inp.addEventListener('change',()=>{ const id=Number(inp.getAttribute('data-edit-lat')); const val=toNumberMaybe(inp.value); updatePointCoord(id,val,null);}));
    tb.querySelectorAll('input[data-edit-lon]').forEach(inp=>inp.addEventListener('change',()=>{ const id=Number(inp.getAttribute('data-edit-lon')); const val=toNumberMaybe(inp.value); updatePointCoord(id,null,val);}));
  }
  function refreshMarkers(){ cluster.clearLayers(); points.forEach(p=>{ if(!p.marker){ const m=L.circleMarker([p.lat,p.lon],{radius:5,weight:1,color:'#1e90ff',fillColor:'#1e90ff',fillOpacity:0.9}); m.bindPopup(popupHtmlForPoint(p)); m.on('popupopen',(ev)=>{ const btn=ev.popup._contentNode.querySelector('button[data-del-marker]'); if(btn) btn.addEventListener('click',()=>{ removePointById(p.id); map.closePopup(); }); }); p.marker=m;} else { p.marker.setLatLng([p.lat,p.lon]); p.marker.setPopupContent(popupHtmlForPoint(p)); } cluster.addLayer(p.marker); }); const enable=points.length>0; $('exportCsvBtn').disabled=!enable; $('exportXlsxBtn').disabled=!enable; $('exportGeojsonBtn').disabled=!enable; renderTable(); }
  function popupHtmlForPoint(p){ const props=p.props||{}; return `Lat: ${formatLatLon(p.lat)}<br>Lon: ${formatLatLon(p.lon)}${(props.tambon||props.amphoe||props.changwat)? `<br><b>ตำบล</b>: ${props.tambon ?? '-'}<br><b>อำเภอ</b>: ${props.amphoe ?? '-'}<br><b>จังหวัด</b>: ${props.changwat ?? '-'}`:''}<div style="margin-top:8px"><button class="btn btn-danger" data-del-marker="${p.id}">ลบจุดนี้</button></div>`; }
  function addPoint(lat,lon){ if(!isFinite(lat)||!isFinite(lon)){ toast('พิกัดไม่ถูกต้อง'); return;} if(lat<-90||lat>90||lon<-180||lon>180){ toast('ช่วงพิกัดผิด (lat −90..90, lon −180..180)'); return;} points.push({id:nextId++,lat,lon,props:{}}); refreshMarkers(); }
  function updatePointCoord(id,newLat,newLon){ const p=points.find(pp=>pp.id===id); if(!p) return; const lat=(newLat===null)?p.lat:newLat; const lon=(newLon===null)?p.lon:newLon; if(!isFinite(lat)||!isFinite(lon)||lat<-90||lat>90||lon<-180||lon>180){ toast('ค่าพิกัดไม่ถูกต้อง'); renderTable(); return;} p.lat=lat; p.lon=lon; if(p.marker) p.marker.setLatLng([p.lat,p.lon]); refreshMarkers(); }
  function removePointById(id){ const idx=points.findIndex(p=>p.id===id); if(idx===-1) return; const p=points[idx]; if(p.marker) cluster.removeLayer(p.marker); points.splice(idx,1); refreshMarkers(); toast('ลบจุดแล้ว'); }

  document.getElementById('addNewRowBtn').addEventListener('click',()=>{ const lat=toNumberMaybe($('newLat').value); const lon=toNumberMaybe($('newLon').value); addPoint(lat,lon); $('newLat').value=''; $('newLon').value=''; });
  map.on('click',(e)=>{ if(!addMode) return; if(tempAddMarker){ map.removeLayer(tempAddMarker); tempAddMarker=null; } tempAddMarker=L.marker(e.latlng,{opacity:0.9}).addTo(map); const lat=e.latlng.lat, lon=e.latlng.lng; const html=`<div><b>ยืนยันเพิ่มจุดนี้</b><br>Lat: ${lat.toFixed(6)}<br>Lon: ${lon.toFixed(6)}</div><div style="margin-top:8px"><button class="btn" id="confirmAddBtn">ยืนยันเพิ่มจุด</button></div>`; tempAddMarker.bindPopup(html); tempAddMarker.once('popupopen',(ev)=>{ if(ev && ev.popup && ev.popup._container){ L.DomEvent.disableClickPropagation(ev.popup._container); } const ok=document.getElementById('confirmAddBtn'); if(ok){ ok.addEventListener('click',()=>{ addPoint(lat,lon); toast(`เพิ่มจุด: ${lat.toFixed(6)}, ${lon.toFixed(6)}`); if(tempAddMarker){ map.removeLayer(tempAddMarker); tempAddMarker=null; } },{once:true}); } }); tempAddMarker.openPopup(); });

  // ----- Load GeoJSON from repo (relative path) -----
  async function loadGeoJSONFromRepo(path='subdistricts.geojson'){
    $('gjStatus').textContent = 'กำลังโหลด GeoJSON จาก repo…';
    try{
      const res = await fetch(path, { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const parsed = await res.json();
      if (!parsed || parsed.type!=='FeatureCollection' || !Array.isArray(parsed.features) || !parsed.features.length) throw new Error('ไฟล์ไม่ใช่ FeatureCollection หรือไม่มี feature');
      const polyFeats = parsed.features.filter(f=>{ const g=f&&f.geometry; return g&&(g.type==='Polygon'||g.type==='MultiPolygon'); });
      if(!polyFeats.length) throw new Error('ไม่พบ Polygon/MultiPolygon');
      geojsonPolygons = { type:'FeatureCollection', features: polyFeats };
      polygonLayer.clearLayers(); polygonLayer.addData(geojsonPolygons);
      map.fitBounds(polygonLayer.getBounds());
      const props = polyFeats[0].properties || {}; const keys = Object.keys(props).sort();
      function fillSelect(selId){ const sel=$(selId); sel.innerHTML=''; keys.forEach(k=>{ const opt=document.createElement('option'); opt.value=k; opt.textContent=k; sel.appendChild(opt); }); }
      fillSelect('fieldTambon'); fillSelect('fieldAmphoe'); fillSelect('fieldChangwat');
      $('fieldMapSection').style.display='block';
      $('joinBtn').disabled=false;
      polyBBoxes = geojsonPolygons.features.map(f=>turf.bbox(f));
      $('gjStatus').textContent = `โหลดจาก repo แล้ว: ${polyFeats.length.toLocaleString()} polygon (${path})`;
      toast('โหลด GeoJSON จาก repo สำเร็จ');
    }catch(err){
      console.error(err);
      $('gjStatus').textContent = 'โหลดจาก repo ไม่สำเร็จ — ตรวจสอบว่ามี subdistricts.geojson อยู่ในโฟลเดอร์เดียวกันกับไฟล์นี้';
    }
  }

  function pointInPolygonJoin(){
    if (!geojsonPolygons || !geojsonPolygons.features?.length){ toast('ยังไม่มีขอบเขต'); return; }
    if (!points.length){ toast('ยังไม่มีจุด'); return; }
    const kT=$('fieldTambon').value, kA=$('fieldAmphoe').value, kC=$('fieldChangwat').value;
    const polys=geojsonPolygons.features;
    let hit=0, miss=0;
    points.forEach(p=>{ p.props=p.props||{}; });
    const ptCache=points.map(p=>turf.point([p.lon,p.lat]));
    for(let i=0;i<points.length;i++){
      const pt=ptCache[i]; let found=false;
      for(let j=0;j<polys.length;j++){
        const bb=polyBBoxes[j]; const x=points[i].lon, y=points[i].lat;
        if(x<bb[0]||x>bb[2]||y<bb[1]||y>bb[3]) continue;
        if(turf.booleanPointInPolygon(pt,polys[j],{ignoreBoundary:false})){
          const prop=polys[j].properties||{};
          points[i].props.tambon=prop[kT]??null;
          points[i].props.amphoe=prop[kA]??null;
          points[i].props.changwat=prop[kC]??null;
          found=true; hit++; break;
        }
      }
      if(!found){ miss++; points[i].props.tambon=points[i].props.amphoe=points[i].props.changwat=null; }
    }
    refreshMarkers();
    toast(`Join เสร็จ: ตรง ${hit.toLocaleString()} / ไม่พบ ${miss.toLocaleString()}`);
  }
  $('joinBtn').addEventListener('click', pointInPolygonJoin);

  // Kick-off
  loadGeoJSONFromRepo(); // auto load from same repo
  </script>
</body>
</html>
